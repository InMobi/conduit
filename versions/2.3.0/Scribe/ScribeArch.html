<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at Jul 8, 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Conduit - GOAL's for Phase1</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140708" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Conduit
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-07-08</span>
                  &nbsp;| <span id="projectVersion">Version: 2.3.0</span>
                          |                           <a href="http://github.com/inmobi/" class="externalLink" title="InMobi">InMobi</a>
        &gt;
                          <a href="http://github.com/inmobi/conduit" class="externalLink" title="Conduit">Conduit</a>
        &gt;
    GOAL's for Phase1
              </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Conduit</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Conduit">Conduit</a>
            </li>
                  <li class="none">
                          <a href="../developer/Overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../developer/Design.html" title="Design">Design</a>
            </li>
                  <li class="none">
                          <a href="../DevSetup/DevSetup.html" title="Dev setup">Dev setup</a>
            </li>
                  <li class="none">
                          <a href="../ConduitLite/ConduitLite.html" title="ConduitLite">ConduitLite</a>
            </li>
                  <li class="none">
                          <a href="../Audit/Audit.html" title="Audit">Audit</a>
            </li>
                  <li class="none">
                          <a href="../Visualization/Visualization.html" title="Visualization">Visualization</a>
            </li>
                  <li class="none">
                          <a href="../Admin/AdminScript.html" title="Admin Script">Admin Script</a>
            </li>
                  <li class="none">
                          <a href="../Monitoring/MonitoringConduit.html" title="Monitoring">Monitoring</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://www.inmobi.com/" title="inmobi" class="poweredBy">
        <img class="poweredBy"  alt="inmobi" src="../../images/inmobi-logo.jpg"     />
      </a>
                       
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <ul><li><a href="#Scribe_Architecture">Scribe Architecture</a><ul><li><a href="#GOALs_for_Phase1">GOAL's for Phase1</a></li><li><a href="#Scribe_File_Store_behavior_w.r.t_Configuration">Scribe File Store behavior w.r.t Configuration</a></li><li><a href="#Scribe_Network_Store_w.r.t_Configuration">Scribe Network Store w.r.t Configuration</a></li><li><a href="#FAQ">FAQ</a></li><li><a href="#Scribe_Configurations_explained_in_detail">Scribe Configurations explained in detail</a></li><li><a href="#Scribe_Monitoring">Scribe Monitoring</a></li><li><a href="#Opens">Opens</a></li><li><a href="#UseCases">UseCases</a></li><li><a href="#References">References</a></li></ul></li></ul><div class="section"><h2>Scribe Architecture<a name="Scribe_Architecture"></a></h2><div class="section"><h3>GOAL's for Phase1<a name="GOALs_for_Phase1"></a></h3><ol style="list-style-type: decimal"><li>Make data available reliabily on HDFS within Data Center</li><li>Static mapping of scribe collectors, configurable without bringing down the scribe daemon</li><li>no VIP/bucket store based load balancing.</li><li>Stores supported - Network &amp; Buffer Store with buffer store supporting FILE Store.</li></ol></div><div class="section"><h3>Scribe File Store behavior w.r.t Configuration<a name="Scribe_File_Store_behavior_w.r.t_Configuration"></a></h3><img src="../images/FileStore.png" alt="" /></div><div class="section"><h3>Scribe Network Store w.r.t Configuration<a name="Scribe_Network_Store_w.r.t_Configuration"></a></h3><img src="../images/NetworkStore.png" alt="" /></div><div class="section"><h3>FAQ<a name="FAQ"></a></h3><table border="1" class="bodyTable"><tr class="a"><th align="left">Question</th><th align="left">How to handle/How it works?</th><th align="left">References</th></tr><tr class="b"><td align="left">What stores can be used as secondary stores</td><td align="left">stores which implement the readOldest() method and currently only file and null stores</td><td align="left"></td></tr><tr class="a"><td align="left">Why does scribe create a new FileSystem for each file.</td><td align="left">Based on our understanding of running/debugging this system for a while there are primary two reasons 1. hadoop filesystem object is cached as is singleton per JVM and since scribe is highly multi-threaded it would benefit from it. 2. DFSClient have a list of blacklisted nodes which AFAIK once formed are kinda static..so to avoid a complete outage that all datanodes are blacklisted and if a datanode was errenous on one connection a seperate thread connecting to the same datanode might be able to move forward. &#xa0;</td><td align="left">http://hadoopblog.blogspot.in/2009/06/hdfs-scribe-integration.html</td></tr><tr class="b"><td align="left">how to handle memory consumption going up</td><td align="left">server-&gt;setResizeBufferEveryN(1); &#xa0;<br />server-&gt;setIdleReadBufferLimit(32*1024); &#xa0;<br />This patch is only available in 0.6 version of thrift.</td><td align="left">https://groups.google.com/group/scribe-server/browse_thread/thread/09f57eaa034ab14a</td></tr><tr class="a"><td align="left">Scenarios in which message loss can occur</td><td align="left">(i) If a client can't connect to either the local or central scribe server the message will be loss. (ii) If a scribe server crashes it could lose a small amount of data that's in memory but not on disk goverend by max_write_size &amp; max_write_interval (iii) Some multiple component failure cases, such as a resender can't connect to any central server and its local disk fills up</td><td align="left">(iii) Some multiple component failure cases, such as a resender can't connect to any central server and its local disk fills up</td></tr><tr class="b"><td align="left">When can duplication of messages occur</td><td align="left">Some rare timeout conditions can lead to duplicate messages</td><td align="left">http://highscalability.com/product-scribe-facebooks-scalable-logging-system</td></tr><tr class="a"><td align="left">buffer store doesn't get drained unless you send a bogus message</td><td align="left">JIRA - https://github.com/facebook/scribe/issues/35</td><td align="left">https://groups.google.com/group/scribe-server/browse_thread/thread/7205e3dd06a6601f</td></tr><tr class="b"><td align="left">if you configure multiple bucket stores in a primary store config and a file store as secondary, then if one of the buckets in down in the store scribe moves to pushing data to secondary store instead of trying the other primary bucket's which are alive</td><td align="left">1. Patch not available in open source &#xa0;<br />2. Check whether we want this scenario</td><td align="left">https://groups.google.com/group/scribe-server/browse_thread/thread/d650a0356d9e6de8</td></tr><tr class="a"><td align="left">Buffer store backs up data when primary store is down. When primary comes up buffer store sends too much of data thereby overwhelming the primary store</td><td align="left">1. Patch available to send dummy bogus message and achieve throttling. &#xa0;<br />2. Patch available in the inmobi</td><td align="left">https://github.com/facebook/scribe/commit/0f32992c27a52fe19f26a521c9f82e1b579a9aa3</td></tr><tr class="b"><td align="left">Whether to retry sending messages</td><td align="left">1. based on must_succeed = YES/NO. Doen't play a role in case of Buffer Store</td><td align="left"></td></tr><tr class="a"><td align="left">How to figure out the sequence of files generated by scribe</td><td align="left">1. use timestamp 2. if (write_meta = YES) lastline will have scribe_meta: followed by next file name</td><td align="left"></td></tr><tr class="b"><td align="left">Can we reload the config</td><td align="left">Only store specific configuration's can be reloaded. Scribe server related config's don't get dynamically reloaded without restarting scribe server. For config's refer - https://github.com/facebook/scribe/wiki/Scribe-Configuration</td><td align="left"></td></tr></table></div><div class="section"><h3>Scribe Configurations explained in detail<a name="Scribe_Configurations_explained_in_detail"></a></h3><ol style="list-style-type: decimal"><li>Scribe Configuration twiki - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/scribe-configuration">https://github.com/facebook/scribe/wiki/scribe-configuration</a></li></ol></div><div class="section"><h3>Scribe Monitoring<a name="Scribe_Monitoring"></a></h3><ol style="list-style-type: decimal"><li>using scribe_ctrl counters. Reference - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/Running-Scribe">https://github.com/facebook/scribe/wiki/Running-Scribe</a></li></ol></div><div class="section"><h3>Opens<a name="Opens"></a></h3><table border="1" class="bodyTable"><tr class="a"><td align="left">Issue</td><th align="left">Resolution</th><th align="left">Status</th></tr><tr class="b"><td align="left">Scribe counters persistence. What if the scribe daemon goes down. How frequent are counters persisted.</td><th align="left">OPEN</th><td align="left"></td></tr><tr class="a"><td align="left">Statergy to make data available to consumers at one place.</td><th align="left">OPEN</th><td align="left"></td></tr><tr class="b"><th align="left">minute based file rotation can generate empty file</th><td align="left">We are ok with this as we'll get data</td><td align="left">CLOSED</td></tr></table></div><div class="section"><h3>UseCases<a name="UseCases"></a></h3><table border="1" class="bodyTable"><caption>Buffer Store - Primary as FileStore(Local FS) &amp;amp; Secondary also FileStore(Local FS)</caption><tr class="a"><th align="left">UseCase</th><th align="left">Behaviour/Observations</th><th align="left">Monitoring to catch</th><th align="left">Opens</th><th align="left">How to try</th></tr><tr class="b"><td align="left"><b>1.</b> Buffer Store - Primary Store being File Store and secondary also being File Store</td><td align="left"><b>1</b>. primary is at /data/scribetestdata/ and secondary is at /tmp/scribetestdata and category name is &quot;test&quot; &#xa0;<br /><b>2.</b> primary store is not reachable( permission issue/disk is full) and client is sending new messages. &#xa0;<br /><b>3.</b> scribe server tries writing to primary fails and retries. &#xa0;<br /><b>4.</b> scribe server won't buffer to secondary till it reaches max_write_interval/max_write_size and keeps the message in memory and retries based on retry_interval/retry_range &#xa0;<br /><b>5.</b> In this example we fixed the permission issue in between the retry interval and scribe server wrote the message to /data/scribetestdata/test/test_00000 &#xa0;<br />Exception &lt; boost::filesystem::create_directory: Permission denied: &quot;/tmp/scribetest/test&quot; &gt; in StdFile::createDirectory for path /tmp/scribetest/test &quot; [Wed Nov 23 11:14:16 2011] &quot;[test] Failed to create directory for file &lt;/tmp/scribetest/test/test_00000&gt;</td><td align="left">scribe server log monitoring for exception's</td><td align="left">When does write to secondary store start. What config controls it?</td><td align="left"></td></tr><tr class="a"><td align="left"><b>2.</b> Send large number of messages to multiple categories</td><td align="left">Each category has it's own queue. Messages from multiple producers will get delivered in the order they went in the queue. No support for prioritization.</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="b"><td align="left"><b>3.</b> When are messages processed from queue - target_write_size or target_write_interval</td><td align="left">whichever config among the two reaches first. Tested and it works.</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="a"><td align="left"><b>4.</b> FIie rotation based on max size in primary and secondary stores</td><td align="left"><b> 1.</b> Change max_write_size to a smaller value and send large number of messages. &#xa0;<br /><b>2.</b> File's get rotated based on max_write_size in both primary and secondary stores. | <b>3.</b> Tested and works</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="b"><td align="left"><b>5.</b> Primary to secondary failover</td><td align="left"><b>1.</b> Revoke permission's of primary store. &#xa0;<br /><b>2.</b> After target_write_size/target_write_interval whichever is reached, messages move to secondary store. &#xa0;<br /><b>3.</b> rotation in secondary store happens based on max_size configured/rotation_period which ever takes effect earlier. &#xa0;<br /><b>4.</b> scribe server keeps retrying based on retry_interval/retry_interval_range &#xa0;<br /><b>5.</b> fix the permission's of primary store &#xa0;<br /><b>6.</b> scribe server starts sending messages from secondary to primary and flushes the secondary. Parallelism of data transfer from primary to secondary is controlled via buffer_send_rate &#xa0;<br /><b>7.</b> Tested above and it works</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="a"><td align="left"><b> 6.</b> Generate Minute files</td><td align="left"><b>1.</b> file rotation within a category is controlled through max_size/rotate_period which ever happens first if both are set. &#xa0;<br /><b>2.</b> rotate_period=1m will generate minute files ( No data in 1 min generates 0 bytes files)</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="b"><td align="left"><b> 7.</b> Throttling through max_msg_sec/max_queue_size</td><td align="left"><b>1.</b> based on whichever reaches first scribe sever sends TRY_LATER to producer &#xa0;<br /><b>2.</b> Tested and works &#xa0;<br /><b>3.</b> This configuration cannot be reloaded dynamically as it's a scribe server config.</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr class="a"><td align="left"><b>8.</b> Stats</td><td align="left"><b>1.</b> Scribe server gives stats and FILE Store also has stats &#xa0;<br />Example Scribe Server stats inderbir@gs1102:~$ sudo ./scribe_ctrl counters 7463 test:retries: 83 test1:received good: 104002 scribe_overall:retries: 83 scribe_overall:received good: 239634 Example for file store stats File named scribe_stats generated inside the category directory eg: /tmp/scribe_tesdata/test/scribe_stats with contents 2011-11-24-12:46 wrote <i>11183</i> bytes in <i>0</i> events to file <i>/tmp/scribetest/test/test_02223</i></td><td align="left"></td><td align="left"></td><td align="left"></td></tr></table><ol style="list-style-type: decimal"><li>Building scribe can be tough since code at github(https://github.com/facebook/scribe) hasn't gone a change from June 2011 and it's dependencies versions have done new releases eg: thrift, libboost.</li><li>from the repository install scribe-server-hdfs &amp; service-scribe-server which will get you all the required dependent packages.</li><li><b>scribe_cat</b>, <b> scribe_ctrl </b> are available inside the source code.<table border="1" class="bodyTable"><tr class="a"><td align="left">Dependency</td><th align="left">Version</th></tr><tr class="b"><td align="left">liboost</td><th align="left"></th></tr><tr class="a"><td align="left">thrift</td><th align="left"></th></tr><tr class="b"><td align="left">fb303</td><th align="left"></th></tr><tr class="a"><td align="left">libevent</td><td align="left">1.4-2</td></tr><tr class="b"><td align="left">libhdfs</td><th align="left"></th></tr></table></li><li><b>cannot import scribe</b>&quot;. Either follow the steps at <a class="externalLink" href="https://github.com/facebook/scribe">https://github.com/facebook/scribe</a> to set PYTHONPATH or you can do [2]</li><li>Checkout fb303, thrift, scribe PYTHON modules and add the following code to scribe_cat<div class="source"><pre>
 sys.path.append('/usr/lib/python2.6/site\-packages/')
 sys.path.append('path to thrift') # path where thrift python packages are
 sys.path.append('path to fb303') # path where fb303 python packages are
 </pre></div></li></ol></div><div class="section"><h3>References<a name="References"></a></h3><ol style="list-style-type: decimal"><li>Scribe Configuration twiki - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/scribe-configuration">https://github.com/facebook/scribe/wiki/scribe-configuration</a></li><li>Running Scribe - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/Running-Scribe">https://github.com/facebook/scribe/wiki/Running-Scribe</a></li><li>Google group - <a class="externalLink" href="https://groups.google.com/group/scribe-server">https://groups.google.com/group/scribe-server</a></li></ol></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2014
                        <a href="https://github.com/InMobi">InMobi</a>.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
