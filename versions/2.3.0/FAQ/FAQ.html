<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at Jul 8, 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Conduit - Conduit client</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140708" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Conduit
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-07-08</span>
                  &nbsp;| <span id="projectVersion">Version: 2.3.0</span>
                          |                           <a href="http://github.com/inmobi/" class="externalLink" title="InMobi">InMobi</a>
        &gt;
                          <a href="http://github.com/inmobi/conduit" class="externalLink" title="Conduit">Conduit</a>
        &gt;
    Conduit client
              </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Conduit</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Conduit">Conduit</a>
            </li>
                  <li class="none">
                          <a href="../developer/Overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../developer/Design.html" title="Design">Design</a>
            </li>
                  <li class="none">
                          <a href="../DevSetup/DevSetup.html" title="Dev setup">Dev setup</a>
            </li>
                  <li class="none">
                          <a href="../ConduitLite/ConduitLite.html" title="ConduitLite">ConduitLite</a>
            </li>
                  <li class="none">
                          <a href="../Audit/Audit.html" title="Audit">Audit</a>
            </li>
                  <li class="none">
                          <a href="../Visualization/Visualization.html" title="Visualization">Visualization</a>
            </li>
                  <li class="none">
                          <a href="../Admin/AdminScript.html" title="Admin Script">Admin Script</a>
            </li>
                  <li class="none">
                          <a href="../Monitoring/MonitoringConduit.html" title="Monitoring">Monitoring</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://www.inmobi.com/" title="inmobi" class="poweredBy">
        <img class="poweredBy"  alt="inmobi" src="../../images/inmobi-logo.jpg"     />
      </a>
                       
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <ul><li><a href="#Conduit_client">Conduit client</a><ul><li><a href="#API_Best_practices">API Best practices</a><ul><li><a href="#How_should_i_gracefully_close_the_consumer">How should i gracefully close the consumer?</a></li><li><a href="#How_do_i_checkpoint_my_consumption_to_withstand_crashes">How do i checkpoint my consumption to withstand crashes?</a></li><li><a href="#How_do_I_make_sure_all_my_messages_are_published_before_closing_the_publisher">How do I make sure all my messages are published, before closing the publisher?</a></li></ul></li><li><a href="#ExceptionsIssues_while_integrating_with_conduit_producerconsumer_library">Exceptions/Issues while integrating with conduit producer/consumer library</a><ul><li><a href="#ReadTimeoutException">ReadTimeoutException</a></li><li><a href="#SLF4J_IllegalAccess_Error">SLF4J IllegalAccess Error</a></li><li><a href="#I_am_calling_publish_but_dont_see_any_messages_in_CONDUIT._What_should_I_do">I am calling publish but don't see any messages in CONDUIT. What should I do?</a></li><li><a href="#FileSystem_closed_Exception_during_consumer_close">FileSystem closed Exception during consumer close</a></li></ul></li></ul></li><li><a href="#Scribe">Scribe</a><ul><li><a href="#Why_do_we_not_use_the_encodeBase64_flag_in_the_secondary_stores">Why do we not use the encodeBase64 flag in the secondary stores?</a></li></ul></li></ul><div class="section"><h2>Conduit client<a name="Conduit_client"></a></h2><div class="section"><h3>API Best practices<a name="API_Best_practices"></a></h3><div class="section"><h4>How should i gracefully close the consumer?<a name="How_should_i_gracefully_close_the_consumer"></a></h4><p>You should call consumer.close() for closing the consumer. If you want to checkpoint your consumption you should call mark() before calling close(). If you want to mark the consumer in shutdown hook, please see the <a href="./#FileSystem_closed_Exception_duri.html">FileSystem closed exception in the below section</a>.</p></div><div class="section"><h4>How do i checkpoint my consumption to withstand crashes?<a name="How_do_i_checkpoint_my_consumption_to_withstand_crashes"></a></h4><p>You should periodically call mark(). Avoid calling mark() after every message, because it will cause IO. But if your application logic mandates to no duplicate processing even with crashes, you might have to call mark() after processing every message.</p></div><div class="section"><h4>How do I make sure all my messages are published, before closing the publisher?<a name="How_do_I_make_sure_all_my_messages_are_published_before_closing_the_publisher"></a></h4><p>For publisher library versions 1.4.x and later: You can publish all the messages and call publisher.close().</p><p>For publisher library versions 1.3.x and earlier :</p><p>Before closing the publisher, wait for all the inflight messages to be published. Sample code is as follows:</p><div class="source"><pre>     // wait for complete
     while (publisher.getStats(topic).getInFlight() &gt; 0) {
       try{
         Thread.sleep(100);
       } catch (InterruptedException e) {
         e.printStackTrace();
         break;
       }
     }
     publisher.close();
</pre></div></div></div><div class="section"><h3>Exceptions/Issues while integrating with conduit producer/consumer library<a name="ExceptionsIssues_while_integrating_with_conduit_producerconsumer_library"></a></h3><div class="section"><h4>ReadTimeoutException<a name="ReadTimeoutException"></a></h4><p>Why I'm seeing the following <a href="./ReadTimeoutException.html">ReadTimeoutException</a> in my publisher logs?</p><div class="source"><pre>WARN netty.ScribeHandler: Exception caught:
org.jboss.netty.handler.timeout.ReadTimeoutException
at org.jboss.netty.handler.timeout.ReadTimeoutHandler.&lt;clinit&gt;(ReadTimeoutHandler.java:84)
at com.inmobi.messaging.netty.ScribePipelineFactory.getPipeline(ScribePipelineFactory.java:27)
at org.jboss.netty.bootstrap.ClientBootstrap.connect(ClientBootstrap.java:212)
at org.jboss.netty.bootstrap.ClientBootstrap.connect(ClientBootstrap.java:188)
at com.inmobi.messaging.netty.ScribeMessagePublisher$ChannelSetter.connect(ScribeMessagePublisher.java:70)
at com.inmobi.messaging.netty.ScribeMessagePublisher.init(ScribeMessagePublisher.java:105)
at com.inmobi.messaging.netty.ScribeMessagePublisher.init(ScribeMessagePublisher.java:121)
at com.inmobi.messaging.publisher.MessagePublisherFactory.create(MessagePublisherFactory.java:87)
at com.inmobi.messaging.publisher.MessagePublisherFactory.create(MessagePublisherFactory.java:62)</pre></div><p><b>Answer:</b></p><p>First of all, note that it is harmless. <a href="./ReadTimeoutException.html">ReadTimeoutException</a> happens when there are no messages sent from publisher within scribe.timeoutSeconds (by default 5 seconds). So, if your frequency of sending messages is more than 5 seconds, the value of scribe.timeoutSeconds in publisher configuration should be increased to higher value. It should be more than your frequency of sending messages to avoid <a href="./ReadTimeoutException.html">ReadTimeoutException</a>.</p></div><div class="section"><h4>SLF4J IllegalAccess Error<a name="SLF4J_IllegalAccess_Error"></a></h4><p>Exception in thread &quot;main&quot; java.lang.IllegalAccessError: tried to access field org.slf4j.impl.StaticLoggerBinder.SINGLETON from class org.slf4j.LoggerFactory</p><div class="source"><pre>at org.slf4j.LoggerFactory.&lt;clinit&gt;(LoggerFactory.java:65)
at com.inmobi.messaging.publisher.AbstractMessagePublisher.&lt;clinit&gt;(AbstractMessagePublisher.java:26)
at java.lang.Class.forName0(Native Method)
at java.lang.Class.forName(Class.java:169)
at com.inmobi.messaging.publisher.MessagePublisherFactory.create(MessagePublisherFactory.java:80)</pre></div><p>As per <a class="externalLink" href="http://www.slf4j.org/faq.html">SLF4J FAQ</a> this happens <a href="./SunSans.html">SunSans</a> -Regular, sans-serif;&quot;&gt;This error is caused by the static initilizer of the <tt><a href="./LoggerFactory.html">LoggerFactory</a></tt><i>code style=&quot;font-family: Courier, monospace;&quot;</i>org.slf4j.impl.StaticLoggerBinder<i>/code</i><i>span style=&quot;font-family: Verdana, Arial, &lt;span class=&quot;</i><a href="./SunSans.html">SunSans</a><i>/span</i>-Regular, sans-serif;&quot;&gt;</p><p>If you get the exception shown above, then you are using an older version of slf4j-api, e.g. 1.4.3, with a new version of a slf4j binding, e.g. 1.5.6. Typically, this occurs when your Maven <i>pom.ml</i> file incoprporates hibernate 3.3.0 which declares a dependency on slf4j-api version 1.4.2. If your <i>pom.xml</i> declares a dependency on an slf4j binding, say slf4j-log4j12 version 1.5.6, then you will get illegal access errors.</p></div><div class="section"><h4>I am calling publish but don't see any messages in CONDUIT. What should I do?<a name="I_am_calling_publish_but_dont_see_any_messages_in_CONDUIT._What_should_I_do"></a></h4><p><tt>publish()</tt> is an async call and if you have a unit test-case which calls publish and exits the JVM you'd find a scenario like this. putting SLEEP in tests might be helpful however we don't expect this to happen in PROD.</p></div><div class="section"><h4>FileSystem closed Exception during consumer close<a name="FileSystem_closed_Exception_during_consumer_close"></a></h4><p>If you are seeing a lot of <a href="./FileSystem.html">FileSystem</a> closed exception while closing consumer, like the one below</p><div class="source"><pre> java.io.IOException: Filesystem closed 
at org.apache.hadoop.hdfs.DFSClient.checkOpen(DFSClient.java:232) 
at org.apache.hadoop.hdfs.DFSClient.access$600(DFSClient.java:70)
at org.apache.hadoop.hdfs.DFSClient$DFSInputStream.close(DFSClient.java:1859)
at java.io.FilterInputStream.close(FilterInputStream.java:155)
at sun.nio.cs.StreamDecoder.implClose(StreamDecoder.java:358)
at sun.nio.cs.StreamDecoder.close(StreamDecoder.java:173)
at java.io.InputStreamReader.close(InputStreamReader.java:182)
at java.io.BufferedReader.close(BufferedReader.java:497)
at com.inmobi.conduit.readers.CollectorStreamReader.closeCurrentFile(CollectorStreamReader.java:125)
at com.inmobi.conduit.readers.CollectorStreamReader.openCurrentFile(CollectorStreamReader.java:108)
at com.inmobi.conduit.readers.StreamReader.openStream(StreamReader.java:49)
at com.inmobi.conduit.partition.AbstractPartitionStreamReader.openStream(AbstractPartitionStreamReader.java:29)
at com.inmobi.conduit.partition.PartitionReader.execute(PartitionReader.java:200)
at com.inmobi.conduit.partition.PartitionReader$1.run(PartitionReader.java:133)
at java.lang.Thread.run(Thread.java:662)</pre></div><p>Then you might be closing your consumer in a shutdown hook. But <a href="./FileSystem.html">FileSystem</a> has a shutdown hook to close all the <a href="./FileSystem.html">FileSystem</a> objects in shutdown hooks. Since the order of shutdown hooks can be arbitrary, so the Filesystems can be closed first, even before closing the Consumer.</p><p><b>Effect</b> : If you are marking the consumer also in shutdown hook, and the filesystem is closed before consumer close, the mark would not succeed.</p><p><b>Fix</b>: The fix is to put the following configuration in your core-site.xml or your hadoop configuration file passed via <tt>messaging.consumer.hadoop.conf</tt> :</p><div class="source"><pre>&lt;?xml version=&quot;1.0&quot;?&gt; 
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
 &lt;configuration&gt; 
&lt;property&gt;
 &lt;name&gt;fs.automatic.close&lt;/name&gt;
 &lt;value&gt;false&lt;/value&gt; 
&lt;description&gt;By default, FileSystem instances are automatically closed at program exit using a JVM shutdown hook.
 Setting this property to false disables this behavior. This is an advanced option that should only be used by server
 applications requiring a more carefully orchestrated shutdown sequence. &lt;/description&gt; 
&lt;/property&gt; 
&lt;/configuration&gt; </pre></div><p>With above configuration, the filesystems wont be closed automatically in shutdown hook.</p></div></div></div><div class="section"><h2>Scribe<a name="Scribe"></a></h2><div class="section"><h3>Why do we not use the encodeBase64 flag in the secondary stores?<a name="Why_do_we_not_use_the_encodeBase64_flag_in_the_secondary_stores"></a></h3><ul><li>If we use this flag in secondary stores then messages will be encoded to base64 while spooling and de-spooling if the encodedBase64 flag is true. We should not use the encodedBase64 flag in secondary stores to avoid the double encoding of messages.</li></ul></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2014
                        <a href="https://github.com/InMobi">InMobi</a>.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
