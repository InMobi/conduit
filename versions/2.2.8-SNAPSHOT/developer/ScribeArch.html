<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at Feb 28, 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Conduit - GOAL's for Phase1</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140228" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Conduit
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-02-28</span>
                  &nbsp;| <span id="projectVersion">Version: 2.2.8-SNAPSHOT</span>
                          |                           <a href="http://github.com/inmobi/" class="externalLink" title="InMobi">InMobi</a>
        &gt;
                          <a href="http://github.com/inmobi/conduit" class="externalLink" title="Conduit">Conduit</a>
        &gt;
    GOAL's for Phase1
              </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Conduit</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Conduit">Conduit</a>
            </li>
                  <li class="none">
                          <a href="../developer/Overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../developer/Design.html" title="Design">Design</a>
            </li>
                  <li class="none">
                          <a href="../developer/DevSetup.html" title="Dev setup">Dev setup</a>
            </li>
                  <li class="none">
                          <a href="../developer/ConduitLite.html" title="ConduitLite">ConduitLite</a>
            </li>
                  <li class="none">
                          <a href="../developer/Audit.html" title="Audit">Audit</a>
            </li>
                  <li class="none">
                          <a href="../developer/Visualization.html" title="Visualization">Visualization</a>
            </li>
                  <li class="none">
                          <a href="../developer/AdminScript.html" title="Admin Script">Admin Script</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../conduit-core/index.html" title="Conduit Core">Conduit Core</a>
            </li>
                  <li class="none">
                          <a href="../conduit-distcp/index.html" title="Conduit Distcp">Conduit Distcp</a>
            </li>
                  <li class="none">
                          <a href="../conduit-worker/index.html" title="Conduit Worker">Conduit Worker</a>
            </li>
                  <li class="none">
                          <a href="../conduit-dist/index.html" title="Conduit Distribution">Conduit Distribution</a>
            </li>
                  <li class="none">
                          <a href="../conduit-audit/index.html" title="Conduit Audit">Conduit Audit</a>
            </li>
                  <li class="none">
                          <a href="../conduit-visualization/index.html" title="Conduit Visualization">Conduit Visualization</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://www.inmobi.com/" title="inmobi" class="poweredBy">
        <img class="poweredBy"  alt="inmobi" src="../../images/inmobi-logo.jpg"     />
      </a>
                       
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <p>%BREADCRUMBS{ format=&quot;$name&quot; separator=&quot; &#xc2;&#xbb; &quot;}%</p><div class="section"><h3>GOAL's for Phase1<a name="GOALs_for_Phase1"></a></h3><p></p><ol style="list-style-type: decimal"><li>Make data available reliabily on HDFS within Data Center</li><li>Static mapping of scribe collectors, configurable without bringing down the scribe daemon</li><li>no VIP/bucket store based load balancing.</li><li>Stores supported - Network &amp; Buffer Store with buffer store supporting FILE Store.</li></ol></div><div class="section"><h4>Scribe File Store behavior w.r.t Configuration<a name="Scribe_File_Store_behavior_w.r.t_Configuration"></a></h4><p><img src="../images/FileStore.png" alt="" /></p></div><div class="section"><h4>Scribe Network Store w.r.t Configuration<a name="Scribe_Network_Store_w.r.t_Configuration"></a></h4><p><img src="../images/NetworkStore.png" alt="" /></p></div><div class="section"><h4>FAQ<a name="FAQ"></a></h4><p></p><table border="0" class="bodyTable"><tr class="a"><th>Question</th><th>How to handle/How it works?</th><th><strong>References<br /></strong></th></tr><tr class="b"><td>What stores can be used as secondary stores</td><td>stores which implement the readOldest() method and currently only file and null stores</td><td></td></tr><tr class="a"><td>Why does scribe create a new <a href="./FileSystem.html">FileSystem</a> for each file.</td><td><p>Based on our understanding of running/debugging this system for a while there are primary two reasons</p> <p>1. hadoop filesystem object is cached as is singleton per JVM and since scribe is highly multi-threaded it would benefit from it.</p> <p>2. DFSClient have a list of blacklisted nodes which AFAIK once formed are kinda static..so to avoid a complete outage that all datanodes are blacklisted and if a datanode was errenous on one connection a seperate thread connecting to the same datanode might be able to move forward.</p></td><td><a class="externalLink" href="http://hadoopblog.blogspot.in/2009/06/hdfs-scribe-integration.html">http://hadoopblog.blogspot.in/2009/06/hdfs-scribe-integration.html</a></td></tr><tr class="b"><td>how to handle memory consumption going up</td><td><p>server->setResizeBufferEveryN(1); <br /> server->setIdleReadBufferLimit(32*1024);</p> This patch is only available in <b>0.6</b> version of <b>thrift</b>.</td><td><a class="externalLink" href="https://groups.google.com/group/scribe-server/browse_thread/thread/09f57eaa034ab14a">https://groups.google.com/group/scribe-server/browse_thread/thread/09f57eaa034ab14a</a></td></tr><tr class="a"><td>Scenarios in which message loss can occur</td><td><p>(i) If a client can't connect to either the local or central scribe server the message will be loss.</p> (ii) If a scribe server crashes it could lose a small amount of data that's in memory but not on disk goverend by <b>max_write_size</b> &amp; <b>max_write_interval</b>  <p>(iii) Some multiple component failure cases, such as a resender can't connect to any central server and its local disk fills up</p> <p> </p></td><td><a class="externalLink" href="http://highscalability.com/product-scribe-facebooks-scalable-logging-system">http://highscalability.com/product-scribe-facebooks-scalable-logging-system</a></td></tr><tr class="b"><td>When can duplication of messages occur</td><td>Some rare timeout conditions can lead to duplicate messages</td><td><p>http://highscalability.com/product-scribe-facebooks-scalable-logging-system</p> <p> </p></td></tr><tr class="a"><td><p>buffer store doesn't get drained unless you send a bogus message.</p> <p> </p></td><td><b>JIRA</b> - <a class="externalLink" href="https://github.com/facebook/scribe/issues/35">https://github.com/facebook/scribe/issues/35</a> <p>Brief - working as expected.</p></td><td><a class="externalLink" href="https://groups.google.com/group/scribe-server/browse_thread/thread/7205e3dd06a6601f">https://groups.google.com/group/scribe-server/browse_thread/thread/7205e3dd06a6601f</a></td></tr><tr class="b"><td><p>if you configure multiple bucket stores in a primary store config and a file store as secondary, then if one of the buckets in down in the store scribe moves to pushing data to secondary store instead of trying the other primary bucket's which are alive</p> <p> </p></td><td><ol> <li>Patch not available in open source</li> </ol></td><td><a class="externalLink" href="https://groups.google.com/group/scribe-server/browse_thread/thread/d650a0356d9e6de8">https://groups.google.com/group/scribe-server/browse_thread/thread/d650a0356d9e6de8</a></td></tr><tr class="a"><td>Buffer store backs up data when primary store is down. When primary comes up buffer store sends too much of data thereby overwhelming the primary store</td><td><ol> <li>Patch available to send dummy bogus message and achieve throttling.</li> </ol></td><td><a class="externalLink" href="https://github.com/facebook/scribe/commit/0f32992c27a52fe19f26a521c9f82e1b579a9aa3">https://github.com/facebook/scribe/commit/0f32992c27a52fe19f26a521c9f82e1b579a9aa3</a></td></tr><tr class="b"><td>Whether to retry sending messages</td><td><ol> <li> based on must_succeed = YES/NO. Doen't play a role in case of Buffer Store</li> </ol></td><td></td></tr><tr class="a"><td>How to figure out the sequence of files generated by scribe</td><td><ol> <li> use timestamp</li> <li>if (write_meta = YES) lastline will have scribe_meta: followed by next file name</li> </ol></td><td></td></tr><tr class="b"><td>Can we reload the config</td><td><ol> <li> Only store specific configuration's can be reloaded. Scribe server related config's don't get dynamically reloaded without restarting scribe server. For config's refer - https://github.com/facebook/scribe/wiki/Scribe-Configuration</li> </ol></td><td></td></tr></table></div><div class="section"><h3>Scribe Configurations explained in detail<a name="Scribe_Configurations_explained_in_detail"></a></h3><p></p><ol style="list-style-type: decimal"><li>Scribe Configuration twiki - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/scribe-configuration">https://github.com/facebook/scribe/wiki/scribe-configuration</a></li></ol></div><div class="section"><h3>Scribe Monitoring<a name="Scribe_Monitoring"></a></h3><p></p><ol style="list-style-type: decimal"><li>using scribe_ctrl counters. Reference - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/Running-Scribe">https://github.com/facebook/scribe/wiki/Running-Scribe</a></li></ol></div><div class="section"><h3>Opens<a name="Opens"></a></h3><p></p><table border="0" class="bodyTable"><tr class="a"><th>Issue</th><th>Resolution</th><th>Status</th></tr><tr class="b"><td>Scribe counters persistence. What if the scribe daemon goes down. How frequent are counters persisted.</td><td></td><td>OPEN</td></tr><tr class="a"><td>Statergy to make data available to consumers at one place.</td><td></td><td>OPEN</td></tr><tr class="b"><td></td><td></td><td></td></tr><tr class="a"><td>minute based file rotation can generate empty file</td><td>We are ok with this as we'll get data</td><td>CLOSED</td></tr><tr class="b"><td></td><td></td><td></td></tr><tr class="a"><td></td><td></td><td></td></tr></table></div><div class="section"><h3>UseCases<a name="UseCases"></a></h3></div><div class="section"><h5>Buffer Store - Primary as FileStore(Local FS) &amp; Secondary also FileStore(Local FS)<a name="Buffer_Store_-_Primary_as_FileStoreLocal_FS__Secondary_also_FileStoreLocal_FS"></a></h5><p></p><table border="0" class="bodyTable"><tr class="a"><th><a href="./UseCase.html">UseCase</a></th><th>Behaviour/Observations</th><th>Monitoring to catch</th><th>Opens</th><th>How to try</th></tr><tr class="b"><td>1. Buffer Store - Primary Store being File Store and secondary also being File Store</td><td><ol> <li>primary is at /data/scribetestdata/ and secondary is at /tmp/scribetestdata and category name is "<strong>test</strong>"</li> <li>primary store is not reachable( permission issue/disk is full) and client is sending new messages.</li> <li>scribe server tries writing to primary fails and retries.</li> <li>scribe server won't buffer to secondary till it reaches max_write_interval/max_write_size and keeps the message in memory and retries based on retry_interval/retry_range </li> <li>In this example we fixed the permission issue in between the retry interval and scribe server wrote the message to /data/scribetestdata/test/test_00000</li> </ol> <p> Exception < boost::filesystem::create_directory: <br /> Permission denied: "/tmp/scribetest/test" > in <br /> StdFile::createDirectory for path /tmp/scribetest/test <br /> " [Wed Nov 23 11:14:16 2011] "[test] Failed to create <br /> directory for file &lt;/tmp/scribetest/test/test_00000 </p></td><td><ol> <li> scribe server log monitoring for exception's.</li> </ol></td><td><ol> <li> When does write to secondary store start. What config controls it?</li> </ol></td><td>Use scribe conf from <a href="../scribe-example.conf"> example-conf </a></td></tr><tr class="a"><td>2. Send large number of messages to multiple categories</td><td><ol> <li>Each category has it's own queue. Messages from multiple producers will get delivered in the order they went in the queue. No support for prioritization. </li> </ol></td><td></td><td></td><td></td></tr><tr class="b"><td>3. When are messages processed from queue - target_write_size or target_write_interval</td><td><ol> <li>whichever config among the two reaches first. Tested and it works. </li> </ol></td><td></td><td></td><td></td></tr><tr class="a"><td>4. File rotation based on max size in primary and secondary stores</td><td><ol> <li> Change max_write_size to a smaller value and send large number of messages.</li> <li>File's get rotated based on max_write_size in both primary and secondary stores.</li> <li>Tested and works</li> </ol></td><td></td><td></td><td></td></tr><tr class="b"><td>5. Primary to secondary failover</td><td><ol> <li>Revoke permission's of primary store.</li> <li>After target_write_size/target_write_interval whichever is reached, messages move to secondary store.</li> <li>rotation in secondary store happens based on max_size configured/rotation_period which ever takes effect earlier.</li> <li>scribe server keeps retrying based on retry_interval/retry_interval_range </li> <li>fix the permission's of primary store</li> <li>scribe server starts sending messages from secondary to primary and flushes the secondary. Parallelism of data transfer from primary to secondary is controlled via buffer_send_rate </li> <li>Tested above and it works</li> </ol></td><td></td><td></td><td></td></tr><tr class="a"><td>6. Generate Minute files</td><td><p>file rotation within a category is controlled through max_size/rotate_period which ever happens first if both are set.</p> rotate_period=1m will generate minute files ( <b>No data in 1 min generates 0 bytes files</b>)</td><td></td><td></td><td></td></tr><tr class="b"><td>7. Throttling through max_msg_sec/max_queue_size</td><td><ol> <li>based on whichever reaches first scribe sever sends TRY_LATER to producer</li> <li>Tested and works</li> <li>This configuration cannot be reloaded dynamically as it's a scribe server config.</li> </ol></td><td></td><td></td><td></td></tr><tr class="a"><td>8. Stats</td><td><ol> <li>Scribe server gives stats and FILE Store also has stats</li> </ol> <p> Example Scribe Server stats <br /> inderbir@gs1102: $ sudo ./scribe_ctrl counters 7463 <br /> test:retries: 83 <br /> test:received good: 135632 <br /> test1:received good: 104002 <br /> scribe_overall:retries: 83 <br /> scribe_overall:received good: 239634 <br /> Example for file store stats File named scribe_stats generated inside the category directory <br />  eg: /tmp/scribe_tesdata/test/scribe_stats with contents <br /> 2011-11-24-12:46 wrote <11183> bytes in <0> events to file </tmp/scribetest/test/test_02223> </p></td><td></td><td></td><td></td></tr></table><ol style="list-style-type: decimal"><li>Building scribe can be tough since code at github(https://github.com/facebook/scribe) hasn't gone a change from June 2011 and it's dependencies versions have done new releases eg: thrift, libboost.</li><li>from the repository install scribe-server-hdfs &amp; service-scribe-server which will get you all the required dependent packages.</li><li><b>scribe_cat</b> &amp;<strong> scribe_ctrl </strong>are available inside the source code.</li></ol><p></p><table border="0" class="bodyTable"><tr class="a"><th>Dependency</th><th>Version</th></tr><tr class="b"><td>liboost</td><td></td></tr><tr class="a"><td>thrift</td><td></td></tr><tr class="b"><td>fb303</td><td></td></tr><tr class="a"><td>libevent</td><td>1.4-2</td></tr><tr class="b"><td>libhdfs</td><td></td></tr></table><ol style="list-style-type: decimal"><li>if you are using scribe_cat to run the client you could hit &quot;<em><strong>cannot import scribe</strong></em>&quot;. Either follow the steps at <a class="externalLink" href="https://github.com/facebook/scribe">https://github.com/facebook/scribe</a> to set PYTHONPATH or you can do [2]</li><li>Checkout fb303, thrift, scribe PYTHON modules from <a class="externalLink" href="http://svn.mkhoj.com/svn/dw/flash/flashmon/trunk/scribe_collect_mon/">http://svn.mkhoj.com/svn/dw/flash/flashmon/trunk/scribe_collect_mon/</a> and add the following code to scribe_cat</li></ol><div class="source"><pre>
 sys.path.append('/usr/lib/python2.6/site-packages/')
 sys.path.append('path to thrift') # path where thrift python packages are
 sys.path.append('path to fb303') # path where fb303 python packages are
 
</pre></div></div><div class="section"><h4>References<a name="References"></a></h4><p></p><ol style="list-style-type: decimal"><li>Scribe Configuration twiki - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/scribe-configuration">https://github.com/facebook/scribe/wiki/scribe-configuration</a></li><li>Running Scribe - <a class="externalLink" href="https://github.com/facebook/scribe/wiki/Running-Scribe">https://github.com/facebook/scribe/wiki/Running-Scribe</a></li><li>Google group - <a class="externalLink" href="https://groups.google.com/group/scribe-server">https://groups.google.com/group/scribe-server</a></li></ol></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2014
                        <a href="https://github.com/InMobi">InMobi</a>.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
