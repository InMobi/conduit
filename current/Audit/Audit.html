<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at Jul 8, 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Conduit - Audit Feature</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140708" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Conduit
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-07-08</span>
                  &nbsp;| <span id="projectVersion">Version: 2.3.0</span>
                          |                           <a href="http://github.com/inmobi/" class="externalLink" title="InMobi">InMobi</a>
        &gt;
                          <a href="http://github.com/inmobi/conduit" class="externalLink" title="Conduit">Conduit</a>
        &gt;
    Audit Feature
              </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Conduit</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Conduit">Conduit</a>
            </li>
                  <li class="none">
                          <a href="../developer/Overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../developer/Design.html" title="Design">Design</a>
            </li>
                  <li class="none">
                          <a href="../DevSetup/DevSetup.html" title="Dev setup">Dev setup</a>
            </li>
                  <li class="none">
                          <a href="../ConduitLite/ConduitLite.html" title="ConduitLite">ConduitLite</a>
            </li>
                  <li class="none">
            <strong>Audit</strong>
          </li>
                  <li class="none">
                          <a href="../Visualization/Visualization.html" title="Visualization">Visualization</a>
            </li>
                  <li class="none">
                          <a href="../Admin/AdminScript.html" title="Admin Script">Admin Script</a>
            </li>
                  <li class="none">
                          <a href="../Monitoring/MonitoringConduit.html" title="Monitoring">Monitoring</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://www.inmobi.com/" title="inmobi" class="poweredBy">
        <img class="poweredBy"  alt="inmobi" src="../../images/inmobi-logo.jpg"     />
      </a>
                       
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <ul><li><a href="#Audit_Feature">Audit Feature</a><ul><li><a href="#Overview">Overview</a></li><li><a href="#Version">Version</a></li><li><a href="#Configuration_Setup">Configuration Setup</a><ul><li><a href="#Publisher_Configuration">Publisher Configuration</a></li><li><a href="#Scribe_Configuration">Scribe Configuration</a><ul><li><a href="#New_configuration_variables">New configuration variables</a></li></ul></li></ul></li><li><a href="#Audit_Query_Tool">Audit Query Tool</a><ul><li><a href="#Usage">Usage</a></li></ul></li><li><a href="#Audit_Phase_2">Audit Phase 2</a><ul><li><a href="#Versions">Versions</a></li><li><a href="#Installation">Installation</a></li></ul></li><li><a href="#Audit_Feeder">Audit Feeder</a><ul><li><a href="#Install">Install</a></li><li><a href="#Start">Start</a></li><li><a href="#Stop">Stop</a></li></ul></li><li><a href="#Audit_Rollup">Audit Rollup</a></li></ul></li></ul><div class="section"><h2>Audit Feature<a name="Audit_Feature"></a></h2><div class="section"><h3>Overview<a name="Overview"></a></h3><p><b>TIERS</b>&gt; in the conduit setup.</p><p>'<b>_audit</b>' topic which is internal to conduit stack. These audit messages flow through conduit in the same way as messages of other topics generated by publisher library. When the publisher library generates a message for any topic, it prepends the message with an immutable header, that contains generation timestamp (and other fields). As and when the messages flow through a tier, that tier tracks the number of messages seen for various publish time periods and periodically generates an audit message capturing this information.</p><p>The following conduit <b>TIERS</b> are supported in the first phase of audit feature: publisher, agent, collector, hdfs. Next phase will support subsequent <b>TIERS</b>: local stream, merged stream, mirror stream. Note that the set of TIERS are defined internally within conduit; they can't be added externally.</p><p>Note that if audit messages get lost/replayed, false negatives are possible. Else if both normal messages and associated audit messages are lost, false positives are possible.</p></div><div class="section"><h3>Version<a name="Version"></a></h3><p>The phase 1 of audit feature is available in the following versions:</p><p>publisher library: 2.x</p><p>scribe agent: 0.4.1 or later</p><p>scribe collector: 0.4.2 or later</p></div><div class="section"><h3>Configuration Setup<a name="Configuration_Setup"></a></h3><div class="section"><h4>Publisher Configuration<a name="Publisher_Configuration"></a></h4><p>By default, audit feature is turned off in messaging-client publisher.</p><p>In order to turn audit feature on, add the below property within messaging-publisher-conf.properties:</p><p><b>audit.enabled=true</b></p></div><div class="section"><h4>Scribe Configuration<a name="Scribe_Configuration"></a></h4><p>By default, audit feature is turned <b>OFF</b> in scribe agent and collector tiers.</p><p>In order to turn audit <b>ON</b>, add a new store in agent and collector configuration with *_audit* as the category.</p><p>Sample configuration for agent: <a href="../Scribe/ScribeAgentconfiguration.html">scribe-agent.conf</a></p><p>Sample configuration for collector: <a href="../Scribe/ScribeCollectorconfiguration.html">scribe-collector.conf</a></p><p><b>The notes section in each of the links above clearly mention what configuration can be manually modified. Please follow it carefully.</b></p><div class="section"><h5>New configuration variables<a name="New_configuration_variables"></a></h5><p><b>tier: </b>The logical TIER that the scribe process is a part of.</p><ul><li>Supported values are &quot;agent&quot; and &quot;collector&quot;</li></ul><p><b>window_size: </b>The granularity (in seconds) at which incoming messages will be bucketed while generating audit stats.</p><ul><li>Default value is 60. This means that all messages generated by publisher within 60 second time window will be counted together. []</li></ul></div></div></div><div class="section"><h3>Audit Query Tool<a name="Audit_Query_Tool"></a></h3><p>The audit feature provides a generic command line tool to execute audit queries. The query can return the stats for any topic at any tier for any given time period.The stats currently emitted are number of messages <b>received</b> by each tier and <b>latency</b> from source in terms of percentile.</p><p>The audit query command is exposed as part of <b>audit-client</b> script that is bundled as part of <b>conduit-audit</b> deb package.</p><div class="section"><h4>Usage<a name="Usage"></a></h4><p>Run audit-client script from the installed location of conduit-audit package (/usr/local/conduit-audit):</p><div class="source"><pre> 
 bin/audit-client audit [-group &lt;TIER,HOSTNAME,TOPIC,CLUSTER&gt;] 
          [-filter &lt;TIER=xxx,HOSTNAME=xxx,TOPIC=xxx,CLUSTER=xxx&gt;] [-percentile &lt;list of percentiles&gt; &lt;dd-mm-yyyy-HH:mm&gt;
          &lt;dd-mm-yyyy-HH:mm&gt; --conf &lt;confdir&gt; 
          </pre></div><p><b>Example:</b></p><p>Consider a setup where publisher, scribe agent, scribe collector and HDFS processes are running on host conduitdev1. User wants to audit all the messages generated by publisher library for a topic 'benchmark_merge' between 08:44 and 09:04 on 24/04/2013.</p><p>Here is an example query to get audit stats and the expected output when there is no data loss:</p><div class="source"><pre>        bin/audit-client audit -group TIER,HOSTNAME,TOPIC -filter topic=benchmark_merge -percentile 99
         24-04-2013-08:44 24-04-2013-09:04  --conf /usr/local/messaging-client/conf 
        
        Warning: JAVA_HOME not set!
        Displaying results for AuditDbQuery [fromTime=24-04 08:44, toTime=24-04 09:04, cutoffTime=1,
        groupBy=GroupBy[HOSTNAME, TOPIC, TIER], filter=Filter{TOPIC=benchmark_merge},
        timeout=120000, rootdir=hdfs://localhost:9000/conduit]
                
        [{&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;TOPIC&quot;:benchmark_merge,&quot;Received&quot;:60000,&quot;CLUSTER&quot;:&quot;conduitdev1&quot;,&quot;TIER&quot;:&quot;publisher&quot;,
        &quot;Latencies&quot;:{&quot;99.0&quot;:1}},{&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;TOPIC&quot;:benchmark_merge,&quot;Received&quot;:60000,&quot;CLUSTER&quot;:&quot;conduitdev1&quot;,
        &quot;TIER&quot;:&quot;AGENT&quot;,&quot;Latencies&quot;:{&quot;99.0&quot;:1},{&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;TOPIC&quot;:benchmark_merge,&quot;Received&quot;:60000,
        &quot;CLUSTER&quot;:&quot;conduitdev1&quot;,&quot;TIER&quot;:&quot;collector&quot;,&quot;Latencies&quot;:{&quot;99.0&quot;:1}},{&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;TOPIC&quot;:benchmark_merge,
        &quot;Received&quot;:60000,&quot;CLUSTER&quot;:&quot;conduitdev1&quot;,&quot;TIER&quot;:&quot;hdfs&quot;,&quot;Latencies&quot;:{&quot;99.0&quot;:2}}]
</pre></div><p><b>'|' symbol whereas columns are separated by ','</b>.</p><p>-filter TOPIC=benchmark_merge|benchmark_local,TIER=hdfs|agent</p><p>The &lt;confdir&gt; location should have audit consumer configuration file named &quot;audit-consumer-conf.properties&quot; for consuming the audit messages.</p><p><a href="../audit-feeder.properties_copy.txt">audit-feeder.properties</a></p></div></div><div class="section"><h3>Audit Phase 2<a name="Audit_Phase_2"></a></h3><p>Audit Phase 2 is the extension of the current audit feature which provides end to end view of data being transfered by conduit.</p><p>Previous version was providing metrics till HDFS and this version adds the remaining tiers LOCAL,MERGE and MIRROR.</p><p>Conduit worker uses messaging publisher to publish audit messages to scribe which in turn writes to HDFS.</p><p>Metrics emitted are same as previous tiers which provide the number of messages received by a tier in a given time frame.</p><p>Audit Query also remains unchanged.</p><div class="section"><h4>Versions<a name="Versions"></a></h4><p>Audit Phase 2 is present in conduit worker version 2.2.0 onwards.</p></div><div class="section"><h4>Installation<a name="Installation"></a></h4><p>1) Setup a local scribe collector to be setup on each worker box and white list the stream &quot;_audit&quot;</p><p>2)Since messaging publisher is used by worker hence now we also need to have a configuration file for the scribe messaging publisher.</p><p>The path of messaging publisher is configurable via the property &quot;com.inmobi.conduit.audit.publisher.config&quot; in the conduit.cfg</p><p>3) upgrade the conduit worker to latest version and restart the service.</p><p>PS:a) No need to setup DISTCP_HOME as distcp is being bundled as part of worker.</p><p>b) From this version onwards conduit would be using reduce slots as well.Both local stream service and merge/mirror has 1 reducer/job now.</p></div></div><div class="section"><h3>Audit Feeder<a name="Audit_Feeder"></a></h3><p>Audit feeder runs as a daemon and is responsible for reading the audit messages generated from all the colos and than process and feed them into a central DB.This daemon leverages the power of pintail to read audit messages from different colos.</p><p>Feeder can be started using the audit-client script which is part of conduit-audit package.</p><div class="section"><h4>Install<a name="Install"></a></h4><p>Steps to install the feeder:</p><ol style="list-style-type: decimal"><li>Install the debian package conduit-audit.</li><li>After installation replace the sample config file located at /usr/local/conduit-audit-&lt;version&gt;/conf/audit-feeder.properties with the actual config file.</li><li>Mandate fields to be set are : db.url,db.username,db.password,messaging.consumer.checkpoint.dir,feeder.conduit.conf,audit.table.master.&lt;br /&gt;Description of each of these config parameters is provided in the sample config file packaged as part of debian.</li><li>After replacing the config start the feeder,following the steps given in &quot;Start&quot; section.</li></ol></div><div class="section"><h4>Start<a name="Start"></a></h4><p>Command to start the feeder is :</p><p>nohup /usr/local/conduit-audit-&lt;version&gt;$ bin/audit-client feeder --conf &lt;path to conf directory&gt; 2&gt;&amp;1 &amp;</p><p>Conf directory must contain </p><ol style="list-style-type: decimal"><li>audit-feeder.properties</li><li>core-site.xml(part of conduit-audit package)<p><a href="../audit-feeder.properties.txt"> audit-feeder.properties </a></p></li></ol><p>Detailed template of the audit-feeeder.properties is part of the conduit-audit package.Please refer to that for all other config params.</p></div><div class="section"><h4>Stop<a name="Stop"></a></h4><p>To stop the feeder issue :</p><p>kill TERM &lt;pid of feeder&gt;;</p></div></div><div class="section"><h3>Audit Rollup<a name="Audit_Rollup"></a></h3><p><a href="./AuditRollup.html">link</a></p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2014
                        <a href="https://github.com/InMobi">InMobi</a>.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
